{% extends 'base.html' %}
{% load static %}

{% block title %}Products - Makola Marketplace{% endblock %}

{% block extra_css %}
<style>
    .hero-slide {
        transition: opacity 0.5s ease-in-out;
    }
    .hero-slide.active {
        opacity: 1;
    }
    .hero-slide:not(.active) {
        opacity: 0;
        position: absolute;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Carousel Section -->
{% if hero_images %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="relative w-full h-[500px] md:h-[600px] rounded-lg overflow-hidden shadow-2xl" x-data="{ 
        currentSlide: 0, 
        slides: [
            {% for img_url in hero_images %}
            '{{ img_url }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }" x-init="setInterval(() => { currentSlide = (currentSlide + 1) % slides.length }, 5000)">
        <!-- Slides -->
        <template x-for="(slide, index) in slides" :key="index">
            <div 
                class="hero-slide absolute inset-0 w-full h-full"
                :class="{ 'active': currentSlide === index }"
            >
                <img 
                    :src="slide" 
                    :alt="'Makola Marketplace Image ' + (index + 1)"
                    class="w-full h-full object-cover"
                    @error="console.error('Failed to load image:', slide); $el.style.display='none'"
                    @load="console.log('Loaded image:', slide)"
                    loading="lazy"
                >
                <!-- Overlay for better text readability -->
                <div class="absolute inset-0 bg-black bg-opacity-30"></div>
            </div>
        </template>
        
        <!-- Hero Content -->
        <div class="relative z-10 flex items-center justify-center h-full">
            <div class="text-center text-white px-4">
                <h1 class="text-4xl md:text-6xl font-bold mb-4 drop-shadow-lg">Welcome to Makola Marketplace</h1>
                <p class="text-xl md:text-2xl mb-8 drop-shadow-lg">Authentic African Groceries in Houston, Texas</p>
                <a href="#products" class="bg-orange-600 text-white px-8 py-3 rounded-lg hover:bg-orange-700 font-semibold text-lg transition-colors inline-block">
                    Shop Now
                </a>
            </div>
        </div>
        
        <!-- Navigation Dots -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-10 flex space-x-2">
            <template x-for="(slide, index) in slides" :key="index">
                <button 
                    @click="currentSlide = index"
                    class="w-3 h-3 rounded-full transition-all"
                    :class="currentSlide === index ? 'bg-white' : 'bg-white bg-opacity-50'"
                ></button>
            </template>
        </div>
        
        <!-- Previous/Next Buttons -->
        <button 
            @click="currentSlide = (currentSlide - 1 + slides.length) % slides.length"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 bg-white bg-opacity-50 hover:bg-opacity-75 text-gray-800 p-2 rounded-full transition-all"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        <button 
            @click="currentSlide = (currentSlide + 1) % slides.length"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 z-10 bg-white bg-opacity-50 hover:bg-opacity-75 text-gray-800 p-2 rounded-full transition-all"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>
</div>
{% endif %}

<div id="products" class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Sidebar Filters -->
        <aside class="w-full lg:w-64">
            <!-- Category Carousel - Quick Search (Above Filter) -->
            {% if all_categories %}
            <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4" x-data="{ 
                scrollPosition: 0,
                scrollAmount: 300,
                scrollContainer: null,
                init() {
                    this.scrollContainer = this.$refs.categoryScroll;
                },
                scrollLeft() {
                    if (this.scrollContainer) {
                        this.scrollContainer.scrollBy({ left: -this.scrollAmount, behavior: 'smooth' });
                    }
                },
                scrollRight() {
                    if (this.scrollContainer) {
                        this.scrollContainer.scrollBy({ left: this.scrollAmount, behavior: 'smooth' });
                    }
                }
            }">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-900">Quick Search</h3>
                    <div class="flex gap-2">
                        <button 
                            @click="scrollLeft()"
                            class="p-1.5 bg-orange-600 text-white rounded-full hover:bg-orange-700 transition-colors shadow-md"
                            aria-label="Scroll left">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <button 
                            @click="scrollRight()"
                            class="p-1.5 bg-orange-600 text-white rounded-full hover:bg-orange-700 transition-colors shadow-md"
                            aria-label="Scroll right">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="relative">
                    <div 
                        x-ref="categoryScroll"
                        class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 scroll-smooth"
                        style="scrollbar-width: none; -ms-overflow-style: none;">
                        <style>
                            .scrollbar-hide::-webkit-scrollbar {
                                display: none;
                            }
                        </style>
                        {% for category in all_categories %}
                            <a href="{% url 'products:category_detail' category.slug %}" 
                               class="flex-shrink-0 bg-gray-50 rounded-lg border border-gray-200 p-3 hover:border-orange-400 hover:shadow-md hover:bg-white transition-all group text-center min-w-[120px]">
                                <div class="mb-2">
                                    <div class="w-12 h-12 mx-auto bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-xs text-gray-900 group-hover:text-orange-600 transition-colors mb-1 line-clamp-2">
                                    {{ category.name }}
                                </h3>
                                <p class="text-xs text-gray-500">{{ category.product_count }}</p>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Filter Section -->
            <div class="bg-white p-4 md:p-6 rounded-lg border border-gray-200 h-fit sticky top-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Filter:</h2>
                    <button onclick="clearFilters()" class="text-sm text-gray-600 hover:text-gray-800">Reset</button>
                </div>
            
            <form method="get" id="filter-form" class="space-y-6">
                <!-- Search -->
                <div>
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search products..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <!-- Availability Filter -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold mb-3">Availability</h3>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" name="in_stock" value="1" {% if in_stock_only %}checked{% endif %} 
                                   class="mr-2 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span>In stock ({{ page_obj.paginator.count }})</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" name="out_of_stock" value="1" 
                                   class="mr-2 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span>Out of stock</span>
                        </label>
                    </div>
                </div>
                
                <!-- Price Filter -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold mb-3">Price</h3>
                    <p class="text-xs text-gray-500 mb-2">The highest price is ${{ max_product_price|floatformat:2|default:"199.99" }} USD</p>
                    <div class="flex gap-2">
                        <input type="number" name="min_price" value="{{ min_price }}" placeholder="From $" 
                               step="0.01" min="0"
                               class="w-1/2 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <input type="number" name="max_price" value="{{ max_price }}" placeholder="To $" 
                               step="0.01" min="0"
                               class="w-1/2 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold mb-3">Category</h3>
                    <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.slug }}" {% if selected_category == category.slug %}selected{% endif %}>
                                {{ category.name }} ({{ category.product_count }})
                            </option>
                        {% empty %}
                            <option value="" disabled>No categories available (Debug: categories={{ categories|length }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 text-sm font-medium transition-colors">
                    Apply Filters
                </button>
            </form>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1">
            <!-- Sort and Results Count -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <p class="text-gray-600 text-sm">
                    {{ page_obj.paginator.count }} products
                </p>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Sort by:</label>
                    <select name="sort" onchange="updateSort(this.value)" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Featured</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Best selling</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Alphabetically, A-Z</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Alphabetically, Z-A</option>
                        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price, low to high</option>
                        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price, high to low</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Date, old to new</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Date, new to old</option>
                    </select>
                </div>
            </div>

            <!-- Product Grid -->
            {% if page_obj %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
                    {% for product in page_obj %}
                        <div class="bg-white rounded-lg overflow-hidden border border-gray-200 hover:border-orange-300 hover:shadow-lg transition-all group">
                            <a href="{% url 'products:product_detail' product.slug %}" class="block">
                                <div class="relative aspect-square overflow-hidden bg-gray-100">
                                    {% if product.get_primary_image %}
                                        <img src="{{ product.get_primary_image.url }}" alt="{{ product.name }}" 
                                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                                    {% else %}
                                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                            <span class="text-gray-400 text-sm">No Image</span>
                                        </div>
                                    {% endif %}
                                    {% if not product.is_in_stock %}
                                        <div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded">
                                            Out of Stock
                                        </div>
                                    {% endif %}
                                </div>
                            </a>
                            <div class="p-4">
                                <a href="{% url 'products:product_detail' product.slug %}">
                                    <h3 class="font-medium text-base mb-2 hover:text-orange-600 line-clamp-2 min-h-[2.5rem]">
                                        {{ product.name }}
                                    </h3>
                                </a>
                                
                                <!-- Rating -->
                                {% with avg_rating=product.get_average_rating %}
                                    {% if avg_rating > 0 %}
                                        <div class="flex items-center mb-2">
                                            <div class="flex items-center">
                                                {% for i in "12345"|make_list %}
                                                    {% if forloop.counter <= avg_rating|floatformat:0 %}
                                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                        </svg>
                                                    {% else %}
                                                        <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                        </svg>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <span class="text-xs text-gray-500 ml-1">
                                                ({{ product.get_review_count }})
                                            </span>
                                        </div>
                                    {% else %}
                                        <p class="text-xs text-gray-400 mb-2">No reviews</p>
                                    {% endif %}
                                {% endwith %}
                                
                                <!-- Price -->
                                <div class="mb-3">
                                    <span class="text-xl font-semibold text-gray-900">${{ product.price }}</span>
                                </div>
                                
                                <!-- Availability -->
                                <p class="text-xs text-gray-500 mb-3">
                                    {% if product.is_in_stock %}
                                        <span class="text-green-600">Checking availability</span>
                                    {% else %}
                                        <span class="text-red-600">Out of stock</span>
                                    {% endif %}
                                </p>
                                
                                <!-- Add to Cart Button -->
                                <form method="post" action="{% url 'cart:add_to_cart' product.id %}" class="mt-auto">
                                    {% csrf_token %}
                                    <input type="hidden" name="quantity" value="1">
                                    <input type="hidden" name="slug" value="{{ product.slug }}">
                                    <input type="hidden" name="redirect_to" value="products:product_list">
                                    <button type="submit" 
                                            class="w-full bg-orange-600 text-white px-4 py-2.5 rounded-md hover:bg-orange-700 transition-colors text-sm font-medium {% if not product.is_in_stock %}opacity-50 cursor-not-allowed{% endif %}" 
                                            {% if not product.is_in_stock %}disabled{% endif %}>
                                        Add to Cart
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <div class="mt-8 flex justify-center">
                        <nav class="flex space-x-2">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" 
                                   class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Previous</a>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <span class="px-4 py-2 bg-orange-600 text-white rounded-lg">{{ num }}</span>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" 
                                       class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">{{ num }}</a>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" 
                                   class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Next</a>
                            {% endif %}
                        </nav>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <p class="text-gray-600 text-lg">No products found. Try adjusting your filters.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function updateSort(value) {
    const url = new URL(window.location);
    url.searchParams.set('sort', value);
    window.location = url;
}

function clearFilters() {
    window.location.href = "{% url 'products:product_list' %}";
}

// Auto-submit form on filter change (optional - for better UX)
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const selects = filterForm.querySelectorAll('select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Optional: auto-submit on category change
            // filterForm.submit();
        });
    });
});
</script>

<!-- Blog/News Section -->
<section class="bg-gray-50 py-12 md:py-16 mt-12">
    <div class="container mx-auto px-4 max-w-7xl">
        <div class="text-center mb-10">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Latest from Makola Marketplace</h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10">
            <!-- Blog Post 1: Cooked Food Area -->
            <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                <a href="{% url 'store:blog_cooked_food' %}" class="block">
                    <div class="grid grid-cols-2 gap-0">
                        <div class="relative h-64 md:h-80 overflow-hidden">
                            <img src="{% static 'logo/Image_12-2-25_at_3.57_PM_2.jpg' %}" 
                                 alt="Makola Marketplace Cooked Food Area" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                        </div>
                        <div class="relative h-64 md:h-80 overflow-hidden">
                            <img src="{% static 'logo/Image_12-2-25_at_4.11_PM_2.jpg' %}" 
                                 alt="Fresh Cooked Meals at Makola Marketplace" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                        </div>
                    </div>
                    <div class="p-6 md:p-8">
                        <h3 class="text-2xl md:text-3xl font-bold text-gray-900 hover:text-orange-600 transition-colors">
                            A Culinary Journey: Our Fresh Cooked Food Section
                        </h3>
                    </div>
                </a>
            </article>
            
            <!-- Blog Post 2: Shopping Experience -->
            <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                <a href="{% url 'store:blog_shopping_experience' %}" class="block">
                    <div class="relative w-full h-96 md:h-[500px] overflow-hidden">
                        <img src="{% static 'logo/Image_12-2-25_at_7.25_PM.jpg' %}" 
                             alt="Shopping Experience at Makola Marketplace" 
                             class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                    </div>
                    <div class="p-6 md:p-8">
                        <h3 class="text-2xl md:text-3xl font-bold text-gray-900 hover:text-orange-600 transition-colors">
                            More Than Shopping: A Community Experience
                        </h3>
                    </div>
                </a>
            </article>
        </div>
    </div>
</section>
{% endblock %}

